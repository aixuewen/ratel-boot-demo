<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ratel.modules.ldap.mapper.LdapMapper">


    <insert id="replaceIntoUser" parameterType="java.util.List" >
        replace into ldap_user
        (id,uid,ujkqchushiDepId,ujkqchushiDepName,ujkqchushiDepNumber,ujkqid,ujkqorderId,ujkqrealName,ujkquserName,ujkquserNumber,userPassword,
        create_time,update_time,enable)
        VALUES
        <foreach collection="list" index="index" item="item"
                 separator=",">
            (#{item.id},#{item.uid},#{item.ujkqchushiDepId},#{item.ujkqchushiDepName},#{item.ujkqchushiDepNumber},#{item.ujkqid},#{item.ujkqorderId},
            #{item.ujkqrealName}, #{item.ujkquserName},#{item.ujkquserNumber},#{item.userPassword},
            now(),now(),'1')
        </foreach>
    </insert>


    <update id="deleteAllUser">
        update ldap_user set enable='0',update_time=now() where ujkquserName!='admin';
    </update>



    <insert id="replaceIntoDept" parameterType="java.util.List" >
        replace into ldap_department
        (id,uid, djkqdepName,djkqdepNumber,djkqId,djkqorderId,djkqparentDepId,create_time,enable,update_time)
        VALUES 
         <foreach collection="list" index="index" item="item"
			separator=",">
			(#{item.id},#{item.uid},#{item.djkqdepName},#{item.djkqdepNumber},#{item.djkqId},#{item.djkqorderId},#{item.djkqparentDepId} ,now(),'1',now())
		</foreach>
    </insert>
    
    <update id="deleteAllDept">
        update ldap_department set enable='0',update_time=now() where id!='-1';
    </update>

    <insert id="replaceIntoSysDept" parameterType="java.util.List" >
        replace into sys_dept
        (id,name,pid,sort,create_time,enable,enabled,update_time,type,status)
        VALUES
        <foreach collection="list" index="index" item="item"
                 separator=",">
            (#{item.id},#{item.name},#{item.pid},#{item.sort},now(),'1',true,now(),#{item.type},#{item.status})
        </foreach>
    </insert>

    <update id="deleteAllSysDept">
        update sys_dept set enable='0',enabled=false,update_time=now() where id!='-1' and type = 'ldap';
    </update>
    <update id="deleteAllSysUsersRoles">
        delete  from sys_users_roles where user_id in (select id from sys_user where type='ldap')
    </update>

    <update id="deleteSysDeptIds">
        delete from sys_user where type = 'ldap'
    </update>
    <insert id="replaceIntoSysUser" parameterType="java.util.List" >
        replace into sys_user
        (id,username,sort,create_time,update_time,enable,enabled,phone,email,nick_name,sys_dept_id,sex,type,status)
        VALUES
        <foreach collection="list" index="index" item="item"
                 separator=",">
            (#{item.id},#{item.username},#{item.sort},now(),now(),#{item.enable},#{item.enabled},#{item.phone},#{item.email},#{item.nickName},#{item.deptId},#{item.sex},#{item.type},#{item.status})
        </foreach>
    </insert>


    <update id="deleteAllSysUser">
        update sys_user set enable='0',enabled=false,update_time=now() where username!='admin'  and type = 'ldap';
    </update>


    <update id="updatePassword" parameterType="java.lang.String">
        update sys_user set password= #{password} , update_time=now() where password is null;
    </update>
    
    <select id="findNotRoleUser" resultType="com.ratel.modules.system.domain.SysUser">
       select u.id from sys_user u where  u.id not in (select user_id from sys_users_roles)
    </select>
    
     <insert id="saveDefaultRole" parameterType="java.util.List" >
        insert into sys_users_roles
        (user_id,role_id)
        VALUES 
         <foreach collection="list" index="index" item="item"
			separator=",">
			(#{item.id},'1')
		</foreach>
    </insert>
    
    <update id="setViewDept" parameterType="java.util.List">
        update sys_dept set des_pid='view',update_time=now() where id in (
        <foreach collection="list" index="index" item="item" separator=",">
			 #{item}
		</foreach>
        )
        
    </update>

    <insert id="replaceIntoSysUserSysDept" >
          INSERT INTO `sys_dept`(`id`, `create_time`, `create_user_id`, `create_user_name`, `data_domain`, `dept_id`, `description`, `enable`, `update_time`, `update_user_id`, `update_user_name`, `des_pid`, `enabled`, `name`, `pid`, `sort`, `type`, `status`, `number_id`)

          select DISTINCT  ujkqchushiDepId as id ,now() as create_time,null as create_user_id ,null as create_user_name,null as data_domain,null as dept_id,"未知来源" as `description`,'1' as `enable`,now() as update_time,null as update_user_id,null as update_user_name,null as des_pid,  true as `enabled`, ujkqchushiDepId  as `name`,'root' as pid,null as sort,'ldap' as type,'0' as status,null as number_id from ldap_user where ujkqchushiDepId not in (select id from sys_dept)

    </insert>
    <insert id="intoDept" parameterType="java.util.Map" >
        insert into sys_dept
        (id,name,pid,sort,create_time,enable,enabled,update_time,type,status)
        VALUES
        (#{id},#{name},#{pid},#{sort},now(),'1',true,now(),#{type},#{status})
        ON DUPLICATE KEY UPDATE
        id = values(id) ,
        name = values(name),
        pid = values(pid),
        sort = values(sort) ,
        enable = values(enable),
        enabled = values(enabled) ,
        update_time =now(),
        type = values(type),
        status = values(status)
    </insert>

    <insert id="intoUser" parameterType="java.util.Map" >
        insert into sys_user
        (id,username,sort,create_time,update_time,enable,enabled,phone,email,nick_name,sys_dept_id,sex,type,status,password)
        VALUES
        (#{id},#{username},#{sort},now(),now(),#{enable},#{enabled},#{phone},#{email},#{nickName},#{deptId},#{sex},#{type},#{status},#{password})
         ON DUPLICATE KEY UPDATE
        id = values(id) ,
        username = values(username),
        sort = values(sort),
        update_time =now(),
        enable = values(enable),
        enabled = values(enabled) ,
        phone = values(phone) ,
        email = values(email) ,
        nick_name = values(nick_name) ,
        sys_dept_id = values(sys_dept_id) ,
        sex = values(sex) ,
        type = values(type),
        status = values(status),
        password = values(password)
    </insert>

    <update id="updateSysDeptPid" parameterType="java.lang.String">
        update sys_dept set pid= #{pid} , update_time=now() where pid = '-1' and id = '0';
    </update>
</mapper>